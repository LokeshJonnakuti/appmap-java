#!/usr/bin/env bash

set -e

fixture_dir=$PWD/build/fixtures
mkdir -p build/fixtures

(
cd build/fixtures
source "$JAVA_HOME/release"

rm -rf spring-petclinic
git clone https://github.com/spring-projects/spring-petclinic.git
cd spring-petclinic

echo "${JAVA_VERSION}"
case "${JAVA_VERSION}" in
  1.8*)
    ;&
  11.*)
    # PetClinic now requires Java 17. When we're testing older JDKs, use the
    # last version that supported 1.8 (and 11). Note that they don't tag
    # versions, so we just use the commit SHA. (We don't use the full hash,
    # though, because Travis detects that as a secret. :( 8 digits should be
    # enough to make a collision extremely unlikely.)
    git checkout 9cb8dde9
    ;;
esac
./mvnw -q package -Dmaven.test.skip=true
)

export BATS_DIR=$PWD/build/bats
mkdir -p build/bats

(
cd build/bats


rm -rf bats-core bats-support bats-assert
git clone --depth 1 https://github.com/bats-core/bats-core.git \
    && git clone --depth 1 https://github.com/bats-core/bats-support.git \
    && git clone --depth 1 https://github.com/bats-core/bats-assert.git \
    && cd bats-core \
    && ./install.sh "$BATS_DIR"
)
